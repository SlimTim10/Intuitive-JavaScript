<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Asynchronous Operations - Intuitive JavaScript</title>
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Big+Shoulders+Display:wght@700&family=Inconsolata:wght@400;700&family=Inter:wght@300;400&display=swap" rel="stylesheet"> 
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
		<link rel="stylesheet" href="../css/reset.css" />
		<link rel="stylesheet" href="../css/default.css" />
		<link rel="stylesheet" href="../css/vs2015.css" />
	</head>
	<body>
		<header>
			<nav>
				<a href="../">Intuitive JavaScript</a>
			</nav>
		</header>

		<main role="main">
			<h1>Asynchronous Operations</h1>
			<article>
	<section id="lesson-body">
		<p>All of our code up until now has involved purely <strong>synchronous</strong> operations. Every operation we run, or function we call, gives us back a result (or produces some output) by the time it is finished running. Operations are normally synchronized with each other: each operation waits to start only after the previous one is finished.</p>
<div class="sourceCode" id="cb1" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1"></a><span class="va">console</span>.<span class="at">log</span>(<span class="st">'first'</span>)<span class="op">;</span></span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw">const</span> fruits <span class="op">=</span> [<span class="st">'apple'</span><span class="op">,</span> <span class="st">'banana'</span><span class="op">,</span> <span class="st">'cherry'</span>]<span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="va">console</span>.<span class="at">log</span>(fruits)<span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5"></a></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="va">console</span>.<span class="at">log</span>(<span class="st">'last'</span>)<span class="op">;</span></span></code></pre></div>
<p>If we run the above code, we will see the output in the order we expect: <code>first</code>, followed by the fruits, and finally <code>last</code>.</p>
<p>On the other hand, <strong>asynchronous</strong> operations do not wait for other operations to finish; they run whenever they are ready. Asynchronous operations come about in two circumstances:</p>
<ul>
<li>when specific timing is involved, or</li>
<li>when dealing with external data (any data from outside of our JavaScript code).</li>
</ul>
<p>There are three ways of handling asynchronous operations: callbacks, promises, and async/await (which is simplified syntax for using promises).</p>
<h2 id="using-callbacks">Using Callbacks</h2>
<p>If a function performs an asynchronous operation, it is up to us to decide what to do after the operation is complete. In order to give us flexibility, the asynchronous function may take in a callback function as an argument. We define the callback function to do whatever it is we want to do after the asynchronous operation, and provide the callback to the asynchronous function. It is the asynchronous function’s job to call our callback function (that’s what makes it a ‘callback’).</p>
<div class="sourceCode" id="cb2" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">const</span> imaginaryAsyncFunc <span class="op">=</span> (callback) <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>  <span class="co">// ... do some asynchronous work here ...</span></span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a>  <span class="at">callback</span>()<span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="op">};</span></span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="kw">const</span> afterOperation <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>  <span class="va">console</span>.<span class="at">log</span>(<span class="st">'The async operation is complete!'</span>)<span class="op">;</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="op">};</span></span>
<span id="cb2-10"><a href="#cb2-10"></a></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="at">imaginaryAsyncFunc</span>(afterOperation)<span class="op">;</span></span></code></pre></div>
<h3 id="timing-example">Timing example</h3>
<p><code>setTimeout()</code> is an asynchronous function that allows us to do something after a specified time. It takes two arguments: a callback function and a number of milliseconds. The callback will run after the specified number of milliseconds. The reason <code>setTimeout()</code> takes a callback as an argument is to allow for some action to be performed after some time. To be flexible (i.e. to allow for any action), a function makes the most sense here. Callbacks are often used for asynchronous operations for exactly this reason. However, using callbacks is not evidence of asynchronous code. As we have seen before, callbacks are frequently used in synchronous code as well.</p>
<p>Let’s try mixing some asynchronous code into the previous example.</p>
<div class="sourceCode" id="cb3" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1"></a><span class="va">console</span>.<span class="at">log</span>(<span class="st">'first'</span>)<span class="op">;</span></span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="kw">const</span> fruits <span class="op">=</span> [<span class="st">'apple'</span><span class="op">,</span> <span class="st">'banana'</span><span class="op">,</span> <span class="st">'cherry'</span>]<span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="at">setTimeout</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>  <span class="va">console</span>.<span class="at">log</span>(fruits)<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="op">},</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8"></a></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="va">console</span>.<span class="at">log</span>(<span class="st">'last'</span>)<span class="op">;</span></span></code></pre></div>
<p>Now, even though the code to print the fruits comes before the code to print <code>last</code>, we will see <code>last</code> show up before the fruits in the output. In fact, it will take one second (1000 milliseconds) before the fruits show up. Even if we set the timeout delay to 0, the fruits will still be the last to print. This is because <strong><em>asynchronous code only runs after all of the synchronous code is finished</em></strong> (always!). In running the above example, when it comes to the <code>setTimeout()</code> code, the callback is put aside, into an imaginary asynchronous box, and then the program carries on with the rest of the synchronous code. After all of the synchronous code is finished, everything inside the asynchronous box gets to run.</p>
<div class="sourceCode" id="cb4" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1"></a><span class="va">console</span>.<span class="at">log</span>(<span class="st">'first'</span>)<span class="op">;</span></span>
<span id="cb4-2"><a href="#cb4-2"></a></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="kw">const</span> fruits <span class="op">=</span> [<span class="st">'apple'</span><span class="op">,</span> <span class="st">'banana'</span><span class="op">,</span> <span class="st">'cherry'</span>]<span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="va">fruits</span>.<span class="at">forEach</span>(fruit <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>  <span class="va">console</span>.<span class="at">log</span>(fruit)<span class="op">;</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="op">}</span>)<span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8"></a></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="va">console</span>.<span class="at">log</span>(<span class="st">'last'</span>)<span class="op">;</span></span></code></pre></div>
<p>The above code uses a callback to print the fruit, but there are no asynchronous operations going on. The output order is the same as in the first example: <code>first</code>, the fruits, then <code>last</code>.</p>
<h3 id="external-data-example">External data example</h3>
<p>Let’s decide on a task: read in a file of text and copy all of the text before ‘<code>---</code>’ to a second file. For example, we can have a file ‘first.txt’ that contains the lines:</p>
<pre class="example"><code>here
are some lines
to copy
---
but none of this
should get copied
</code></pre>
<p>Our program should copy only the first three lines to another file ‘second.txt’.</p>
<p>Node comes with a built-in module <code>fs</code> for dealing with any file system operations. Because these operations deal with data from outside of our code, they are asynchronous. The <code>readFile()</code> function will allow us to read in a file and store its contents. As per the <a href="https://nodejs.org/api/fs.html#fs_fs_readfile_path_options_callback">documentation</a>, it takes in three arguments: a path to the file (string), an encoding of the file content (string), and a callback. The callback will run after the operation is complete. In order to provide the callback, we also need to know what arguments it takes in. Remember, it is not our job to call the callback; it is <code>readFile()</code> that will call it, passing it specific arguments. We only decide what to do with the information given to the callback’s arguments. The documentation says the callback takes in two arguments: a possible error (object), and the file’s contents (string). When dealing with external data, things can always go wrong and in many different ways (e.g., trying to read a file that doesn’t exist). (Technically, the arguments to <code>readFile()</code> are more flexible than this but we can ignore that for our purposes.)</p>
<p>We now have enough information to start. Let’s print the file’s contents.</p>
<div class="sourceCode" id="cb6" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">'fs'</span>)<span class="op">;</span> <span class="co">// Import the module as one big object</span></span>
<span id="cb6-2"><a href="#cb6-2"></a></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="kw">const</span> afterRead <span class="op">=</span> (err<span class="op">,</span> data) <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="cf">if</span> (err) <span class="cf">throw</span> err<span class="op">;</span> <span class="co">// Print the error and quit</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>  <span class="va">console</span>.<span class="at">log</span>(<span class="st">'File contents:'</span>)<span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>  <span class="va">console</span>.<span class="at">log</span>(data)<span class="op">;</span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="op">};</span></span>
<span id="cb6-8"><a href="#cb6-8"></a></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="co">// Read a file called 'first.txt' in the same directory as this js file</span></span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="co">// utf8 is the most common text encoding</span></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="va">fs</span>.<span class="at">readFile</span>(<span class="st">'first.txt'</span><span class="op">,</span> <span class="st">'utf8'</span><span class="op">,</span> afterRead)<span class="op">;</span></span></code></pre></div>
<p>Try it out and see what happens when the file ‘first.txt’ doesn’t exist versus after you create it.</p>
<p>The next step is to extract from the content the part we want to copy. At this point, we are dealing with a plain string, so we can use string manipulation techniques we should be familiar with by now. The <code>split()</code> method works well here.</p>
<div class="sourceCode" id="cb7" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">'fs'</span>)<span class="op">;</span> <span class="co">// Import the module as one big object</span></span>
<span id="cb7-2"><a href="#cb7-2"></a></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="kw">const</span> afterRead <span class="op">=</span> (err<span class="op">,</span> data) <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>  <span class="cf">if</span> (err) <span class="cf">throw</span> err<span class="op">;</span> <span class="co">// Print the error and quit</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>  <span class="kw">const</span> parts <span class="op">=</span> <span class="va">data</span>.<span class="at">split</span>(<span class="st">'---'</span>)<span class="op">;</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>  <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Contents to copy:'</span>)<span class="op">;</span></span>
<span id="cb7-7"><a href="#cb7-7"></a>  <span class="va">console</span>.<span class="at">log</span>(parts[<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="op">};</span></span>
<span id="cb7-9"><a href="#cb7-9"></a></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="va">fs</span>.<span class="at">readFile</span>(<span class="st">'first.txt'</span><span class="op">,</span> <span class="st">'utf8'</span><span class="op">,</span> afterRead)<span class="op">;</span></span></code></pre></div>
<p>Now for dealing with the second file, the <code>writeFile()</code> function allows us to write to a file. It will create the file if it doesn’t exist. As per the <a href="https://nodejs.org/api/fs.html#fs_fs_writefile_file_data_options_callback">documentation</a>, the function takes in four arguments: a path to the file (string), the data to write (string), an encoding of the file content (string), and a callback. This time, the callback only takes a single argument: a possible error (object). The file writing operation either succeeds or it doesn’t; there is no extra data to work with. The callback will be called after the operation is complete. We can now use <code>writeFile()</code> to finish the task and have its callback print a fitting message.</p>
<div class="sourceCode" id="cb8" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">'fs'</span>)<span class="op">;</span> <span class="co">// Import the module as one big object</span></span>
<span id="cb8-2"><a href="#cb8-2"></a></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="kw">const</span> afterWrite <span class="op">=</span> err <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>  <span class="cf">if</span> (err) <span class="cf">throw</span> err<span class="op">;</span> <span class="co">// Print the error and quit</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>  <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Successfully copied the contents!'</span>)<span class="op">;</span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="op">};</span></span>
<span id="cb8-7"><a href="#cb8-7"></a></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="kw">const</span> afterRead <span class="op">=</span> (err<span class="op">,</span> data) <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb8-9"><a href="#cb8-9"></a>  <span class="cf">if</span> (err) <span class="cf">throw</span> err<span class="op">;</span> <span class="co">// Print the error and quit</span></span>
<span id="cb8-10"><a href="#cb8-10"></a>  <span class="kw">const</span> parts <span class="op">=</span> <span class="va">data</span>.<span class="at">split</span>(<span class="st">'---'</span>)<span class="op">;</span></span>
<span id="cb8-11"><a href="#cb8-11"></a>  <span class="va">fs</span>.<span class="at">writeFile</span>(<span class="st">'second.txt'</span><span class="op">,</span> parts[<span class="dv">0</span>]<span class="op">,</span> <span class="st">'utf8'</span><span class="op">,</span> afterWrite)<span class="op">;</span></span>
<span id="cb8-12"><a href="#cb8-12"></a><span class="op">};</span></span>
<span id="cb8-13"><a href="#cb8-13"></a></span>
<span id="cb8-14"><a href="#cb8-14"></a><span class="va">fs</span>.<span class="at">readFile</span>(<span class="st">'first.txt'</span><span class="op">,</span> <span class="st">'utf8'</span><span class="op">,</span> afterRead)<span class="op">;</span></span>
<span id="cb8-15"><a href="#cb8-15"></a></span>
<span id="cb8-16"><a href="#cb8-16"></a><span class="va">console</span>.<span class="at">log</span>(<span class="st">'Starting task...'</span>)<span class="op">;</span> <span class="co">// This prints first!</span></span></code></pre></div>
<p>There are two important things to notice with our finished code. First, the line that has been added to the end will be first to print because it is synchronous while the rest of the code is triggered by the asynchronous <code>readFile()</code>. Second, the code does not read very linearly. It takes significant mental effort to trace the order of operations in this code. This can be changed by replacing the callbacks with their equivalent anonymous functions.</p>
<div class="sourceCode" id="cb9" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">'fs'</span>)<span class="op">;</span> <span class="co">// Import the module as one big object</span></span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="va">fs</span>.<span class="at">readFile</span>(<span class="st">'first.txt'</span><span class="op">,</span> <span class="st">'utf8'</span><span class="op">,</span> (err<span class="op">,</span> data) <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>  <span class="cf">if</span> (err) <span class="cf">throw</span> err<span class="op">;</span> <span class="co">// Print the error and quit</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>  <span class="kw">const</span> parts <span class="op">=</span> <span class="va">data</span>.<span class="at">split</span>(<span class="st">'---'</span>)<span class="op">;</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>  <span class="va">fs</span>.<span class="at">writeFile</span>(<span class="st">'second.txt'</span><span class="op">,</span> parts[<span class="dv">0</span>]<span class="op">,</span> <span class="st">'utf8'</span><span class="op">,</span> err <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb9-7"><a href="#cb9-7"></a>    <span class="cf">if</span> (err) <span class="cf">throw</span> err<span class="op">;</span> <span class="co">// Print the error and quit</span></span>
<span id="cb9-8"><a href="#cb9-8"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Successfully copied the contents!'</span>)<span class="op">;</span></span>
<span id="cb9-9"><a href="#cb9-9"></a>  <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb9-10"><a href="#cb9-10"></a><span class="op">}</span>)<span class="op">;</span></span>
<span id="cb9-11"><a href="#cb9-11"></a></span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="va">console</span>.<span class="at">log</span>(<span class="st">'Starting task...'</span>)<span class="op">;</span> <span class="co">// This prints first!</span></span></code></pre></div>
<p>In the above code, the order of operations now matches the written order (top to bottom), with the exception of the last line. However, there is a cascading effect. As more asynchronous operations are added (and we follow standard code styling), their callbacks are indented more and more. If we added ten more successive asynchronous operations, the last one’s code would be indented quite a lot! It seems we have to make a decision with unfortunate tradeoffs. This is where promises help.</p>
<h2 id="using-promises">Using Promises</h2>
<p>As a sidenote, this material will not be about <em>creating</em> promises. It is much more important to learn how to <em>use</em> them. Just like we don’t need to know how to create <code>console.log()</code> or other built-in functions from scratch, even if the knowledge may be interesting. In practice, you can go a long way without ever needing to create your own promises. Once you are comfortable with using promises, you should be able to easily learn how to create them as well.</p>
<p><strong>Promises</strong> are special objects for dealing with asynchronous operations. A promise has three potential states: pending, fulfilled, and rejected. This suits the pattern of what happens when dealing with external data. Taking the previous example of reading in the contents of a text file on our computer, the operation ‘read in the contents of first.txt’ will first be pending while node looks for ‘first.txt’ (this is what makes it asynchronous). Once the file is found and its contents are read in, the operation is fulfilled and we can then do what we want with the file’s contents. If instead the file is not found because it doesn’t exist, the operation is rejected and we can print a message saying so.</p>
<p>The pending state is entered simply by calling a function that returns a promise. To handle the fulfilled state, promises have a <code>then()</code> method. To handle the rejected state, there is the <code>catch()</code> method. Both <code>then()</code> and <code>catch()</code> take in a single argument: a callback. In the case of <code>then()</code>, the callback may have an argument to store some data that is provided by the completed asynchronous operation. For <code>catch()</code>, the callback typically only has the asynchronous operation’s error as its argument.</p>
<p>Both <code>then()</code> and <code>catch()</code> do something interesting: they return a promise containing the result of the callback. This allows these promise methods to be used on each other, chaining one onto the previous.</p>
<h3 id="external-data-example-1">External data example</h3>
<p>We use the same task as before: read in a file of text and copy all of the text before ‘<code>---</code>’ to a second file.</p>
<p>Node also includes a version of the <code>fs</code> module that uses promises instead of callbacks for asynchronous functions. Depending on your version of node, it can be imported either as:</p>
<div class="sourceCode" id="cb10" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">'fs/promises'</span>)<span class="op">;</span></span></code></pre></div>
<p>Or:</p>
<div class="sourceCode" id="cb11" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">'fs'</span>).<span class="at">promises</span><span class="op">;</span></span></code></pre></div>
<p>The promise version of <code>readFile()</code> takes in the same arguments as its counterpart, minus the callback. As per the <a href="https://nodejs.org/api/fs.html#fs_fspromises_readfile_path_options">documentation</a>, this leaves us with two arguments: a path to the file (string), and an encoding of the file content (string). The function returns a promise which provides the contents of the file upon being fulfilled, or an error (object) upon being rejected.</p>
<p>Let’s print the file’s contents, this time using promises.</p>
<div class="sourceCode" id="cb12" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">'fs'</span>).<span class="at">promises</span><span class="op">;</span> <span class="co">// Import the module as one big object</span></span>
<span id="cb12-2"><a href="#cb12-2"></a></span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="kw">const</span> readPromise <span class="op">=</span> <span class="va">fs</span>.<span class="at">readFile</span>(<span class="st">'first.txt'</span><span class="op">,</span> <span class="st">'utf8'</span>)<span class="op">;</span></span>
<span id="cb12-4"><a href="#cb12-4"></a></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="va">readPromise</span>.<span class="at">then</span>(data <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb12-6"><a href="#cb12-6"></a>  <span class="va">console</span>.<span class="at">log</span>(<span class="st">'File contents:'</span>)<span class="op">;</span></span>
<span id="cb12-7"><a href="#cb12-7"></a>  <span class="va">console</span>.<span class="at">log</span>(data)<span class="op">;</span></span>
<span id="cb12-8"><a href="#cb12-8"></a><span class="op">}</span>)<span class="op">;</span></span>
<span id="cb12-9"><a href="#cb12-9"></a></span>
<span id="cb12-10"><a href="#cb12-10"></a><span class="va">readPromise</span>.<span class="at">catch</span>(err <span class="kw">=&gt;</span> <span class="op">{</span> <span class="co">// Catch any errors with readFile</span></span>
<span id="cb12-11"><a href="#cb12-11"></a>  <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Something went wrong with readFile:'</span>)<span class="op">;</span></span>
<span id="cb12-12"><a href="#cb12-12"></a>  <span class="va">console</span>.<span class="at">log</span>(err)<span class="op">;</span></span>
<span id="cb12-13"><a href="#cb12-13"></a><span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
<p>As different as it may look, this code works the same as the corresponding step in the callback example. Typically, promises are not used quite this way. It is more common to take advantage of the chaining aspect of promises as follows.</p>
<div class="sourceCode" id="cb13" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">'fs'</span>).<span class="at">promises</span><span class="op">;</span> <span class="co">// Import the module as one big object</span></span>
<span id="cb13-2"><a href="#cb13-2"></a></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="va">fs</span>.<span class="at">readFile</span>(<span class="st">'first.txt'</span><span class="op">,</span> <span class="st">'utf8'</span>)</span>
<span id="cb13-4"><a href="#cb13-4"></a>  .<span class="at">then</span>(data <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb13-5"><a href="#cb13-5"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'File contents:'</span>)<span class="op">;</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>    <span class="va">console</span>.<span class="at">log</span>(data)<span class="op">;</span></span>
<span id="cb13-7"><a href="#cb13-7"></a>  <span class="op">}</span>)</span>
<span id="cb13-8"><a href="#cb13-8"></a>  .<span class="at">catch</span>(err <span class="kw">=&gt;</span> <span class="op">{</span> <span class="co">// Catch any errors with readFile</span></span>
<span id="cb13-9"><a href="#cb13-9"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Something went wrong with readFile:'</span>)<span class="op">;</span></span>
<span id="cb13-10"><a href="#cb13-10"></a>    <span class="va">console</span>.<span class="at">log</span>(err)<span class="op">;</span></span>
<span id="cb13-11"><a href="#cb13-11"></a>  <span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
<p>If anything goes wrong in the reading operation, the <code>then()</code> will be skipped and the <code>catch()</code> will run instead. This is advantageous over the callback example, since the error handling is not in the same block of code as dealing with the file’s contents.</p>
<p>The rest of the task can be completed using <code>writeFile()</code> similarly as before.</p>
<div class="sourceCode" id="cb14" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb14-1"><a href="#cb14-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">'fs'</span>).<span class="at">promises</span><span class="op">;</span> <span class="co">// Import the module as one big object</span></span>
<span id="cb14-2"><a href="#cb14-2"></a></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="va">fs</span>.<span class="at">readFile</span>(<span class="st">'first.txt'</span><span class="op">,</span> <span class="st">'utf8'</span>)</span>
<span id="cb14-4"><a href="#cb14-4"></a>  .<span class="at">then</span>(data <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>    <span class="kw">const</span> parts <span class="op">=</span> <span class="va">data</span>.<span class="at">split</span>(<span class="st">'---'</span>)<span class="op">;</span></span>
<span id="cb14-6"><a href="#cb14-6"></a>    <span class="va">fs</span>.<span class="at">writeFile</span>(<span class="st">'second.txt'</span><span class="op">,</span> parts[<span class="dv">0</span>]<span class="op">,</span> <span class="st">'utf8'</span>)</span>
<span id="cb14-7"><a href="#cb14-7"></a>      .<span class="at">then</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb14-8"><a href="#cb14-8"></a>        <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Successfully copied the contents!'</span>)<span class="op">;</span></span>
<span id="cb14-9"><a href="#cb14-9"></a>      <span class="op">}</span>)</span>
<span id="cb14-10"><a href="#cb14-10"></a>      .<span class="at">catch</span>(err <span class="kw">=&gt;</span> <span class="op">{</span> <span class="co">// Catch any errors with writeFile</span></span>
<span id="cb14-11"><a href="#cb14-11"></a>        <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Something went wrong with writeFile:'</span>)<span class="op">;</span></span>
<span id="cb14-12"><a href="#cb14-12"></a>        <span class="va">console</span>.<span class="at">log</span>(err)<span class="op">;</span></span>
<span id="cb14-13"><a href="#cb14-13"></a>      <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb14-14"><a href="#cb14-14"></a>  <span class="op">}</span>)</span>
<span id="cb14-15"><a href="#cb14-15"></a>  .<span class="at">catch</span>(err <span class="kw">=&gt;</span> <span class="op">{</span> <span class="co">// Catch any errors with readFile</span></span>
<span id="cb14-16"><a href="#cb14-16"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Something went wrong with readFile:'</span>)<span class="op">;</span></span>
<span id="cb14-17"><a href="#cb14-17"></a>    <span class="va">console</span>.<span class="at">log</span>(err)<span class="op">;</span></span>
<span id="cb14-18"><a href="#cb14-18"></a>  <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb14-19"><a href="#cb14-19"></a></span>
<span id="cb14-20"><a href="#cb14-20"></a><span class="va">console</span>.<span class="at">log</span>(<span class="st">'Starting task...'</span>)<span class="op">;</span></span></code></pre></div>
<p>The above code can be cleaned up by again taking advantage of chaining. If we instead return the <code>writeFile()</code> result, which is a promise, we can chain another <code>then()</code> after the first one. A side effect of this is that the <code>catch()</code> will catch any errors from both <code>readFile()</code> and <code>writeFile()</code>, for better or for worse.</p>
<div class="sourceCode" id="cb15" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">'fs'</span>).<span class="at">promises</span><span class="op">;</span> <span class="co">// Import the module as one big object</span></span>
<span id="cb15-2"><a href="#cb15-2"></a></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="va">fs</span>.<span class="at">readFile</span>(<span class="st">'first.txt'</span><span class="op">,</span> <span class="st">'utf8'</span>)</span>
<span id="cb15-4"><a href="#cb15-4"></a>  .<span class="at">then</span>(data <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb15-5"><a href="#cb15-5"></a>    <span class="kw">const</span> parts <span class="op">=</span> <span class="va">data</span>.<span class="at">split</span>(<span class="st">'---'</span>)<span class="op">;</span></span>
<span id="cb15-6"><a href="#cb15-6"></a>    <span class="cf">return</span> <span class="va">fs</span>.<span class="at">writeFile</span>(<span class="st">'second.txt'</span><span class="op">,</span> parts[<span class="dv">0</span>]<span class="op">,</span> <span class="st">'utf8'</span>)<span class="op">;</span></span>
<span id="cb15-7"><a href="#cb15-7"></a>  <span class="op">}</span>)</span>
<span id="cb15-8"><a href="#cb15-8"></a>  .<span class="at">then</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb15-9"><a href="#cb15-9"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Successfully copied the contents!'</span>)<span class="op">;</span></span>
<span id="cb15-10"><a href="#cb15-10"></a>  <span class="op">}</span>)</span>
<span id="cb15-11"><a href="#cb15-11"></a>  .<span class="at">catch</span>(err <span class="kw">=&gt;</span> <span class="op">{</span> <span class="co">// Catch any errors</span></span>
<span id="cb15-12"><a href="#cb15-12"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Something went wrong:'</span>)<span class="op">;</span></span>
<span id="cb15-13"><a href="#cb15-13"></a>    <span class="va">console</span>.<span class="at">log</span>(err)<span class="op">;</span></span>
<span id="cb15-14"><a href="#cb15-14"></a>  <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb15-15"><a href="#cb15-15"></a></span>
<span id="cb15-16"><a href="#cb15-16"></a><span class="va">console</span>.<span class="at">log</span>(<span class="st">'Starting task...'</span>)<span class="op">;</span></span></code></pre></div>
<p>From here, we could continue the chaining pattern to add successive asynchronous operations and our code would remain linear without increasing indentation. While this is an improvement on the pure callback approach, we are still dealing with callbacks inside of <code>then()</code> and <code>catch()</code>. The following section shows how we can avoid callbacks altogether and write linear-reading code that involves asynchronous operations.</p>
<h2 id="using-asyncawait">Using Async/Await</h2>
<p>The <strong>async</strong> and <strong>await</strong> keywords are syntactic sugar over promises, meaning they use promises exactly the same way as described above but simply make the code look different. Instead of having a function explicitly return a promise, it can be defined with the word ‘async’ before it.</p>
<div class="sourceCode" id="cb16" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw">const</span> someFunc <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>  <span class="co">// ... do something asynchronous stuff ...</span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="op">};</span></span></code></pre></div>
<p>And instead of using <code>then()</code> on a function returning a promise, it can be called with the word ‘await’ before it.</p>
<div class="sourceCode" id="cb17" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb17-1"><a href="#cb17-1"></a><span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="at">someFunc</span>()<span class="op">;</span></span></code></pre></div>
<p>There are two rules to using async/await:</p>
<ol>
<li>If a function is defined with ‘async’, then it can be called with ‘await’.</li>
<li>‘await’ can only be used inside a function defined with ‘async’.</li>
</ol>
<p>So to transform the first part of our previous code from using explicit promises to async/await, we can ‘await’ the call to <code>readFile()</code>.</p>
<div class="sourceCode" id="cb18" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb18-1"><a href="#cb18-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">'fs'</span>).<span class="at">promises</span><span class="op">;</span></span>
<span id="cb18-2"><a href="#cb18-2"></a></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="va">fs</span>.<span class="at">readFile</span>(<span class="st">'first.txt'</span><span class="op">,</span> <span class="st">'utf8'</span>)<span class="op">;</span></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="va">console</span>.<span class="at">log</span>(<span class="st">'File contents:'</span>)<span class="op">;</span></span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="va">console</span>.<span class="at">log</span>(data)<span class="op">;</span></span></code></pre></div>
<p>However, there is a catch. The above code won’t run in node because we violated rule 2. We have used ‘await’ outside of an async function. There is a simple trick to fix this: we can put the code inside an async function, then call the function.</p>
<div class="sourceCode" id="cb19" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">'fs'</span>).<span class="at">promises</span><span class="op">;</span></span>
<span id="cb19-2"><a href="#cb19-2"></a></span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="kw">const</span> go <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb19-4"><a href="#cb19-4"></a>  <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="va">fs</span>.<span class="at">readFile</span>(<span class="st">'first.txt'</span><span class="op">,</span> <span class="st">'utf8'</span>)<span class="op">;</span></span>
<span id="cb19-5"><a href="#cb19-5"></a>  <span class="va">console</span>.<span class="at">log</span>(<span class="st">'File contents:'</span>)<span class="op">;</span></span>
<span id="cb19-6"><a href="#cb19-6"></a>  <span class="va">console</span>.<span class="at">log</span>(data)<span class="op">;</span></span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="op">};</span></span>
<span id="cb19-8"><a href="#cb19-8"></a></span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="at">go</span>()<span class="op">;</span></span></code></pre></div>
<p>With the exception of the ‘go’ function, we already have a cleaner result than its promise or callback counterpart. The steps appear linear even though we are dealing with an asynchronous operation.</p>
<p>Applying the async/await syntax to the rest of the task gives us the following result.</p>
<div class="sourceCode" id="cb20" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb20-1"><a href="#cb20-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">'fs'</span>).<span class="at">promises</span><span class="op">;</span></span>
<span id="cb20-2"><a href="#cb20-2"></a></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="kw">const</span> go <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb20-4"><a href="#cb20-4"></a>  <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Starting task...'</span>)<span class="op">;</span></span>
<span id="cb20-5"><a href="#cb20-5"></a>  <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="va">fs</span>.<span class="at">readFile</span>(<span class="st">'first.txt'</span><span class="op">,</span> <span class="st">'utf8'</span>)<span class="op">;</span></span>
<span id="cb20-6"><a href="#cb20-6"></a>  <span class="kw">const</span> parts <span class="op">=</span> <span class="va">data</span>.<span class="at">split</span>(<span class="st">'---'</span>)<span class="op">;</span></span>
<span id="cb20-7"><a href="#cb20-7"></a>  <span class="cf">await</span> <span class="va">fs</span>.<span class="at">writeFile</span>(<span class="st">'second.txt'</span><span class="op">,</span> parts[<span class="dv">0</span>]<span class="op">,</span> <span class="st">'utf8'</span>)<span class="op">;</span></span>
<span id="cb20-8"><a href="#cb20-8"></a>  <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Successfully copied the contents!'</span>)<span class="op">;</span></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="op">};</span></span>
<span id="cb20-10"><a href="#cb20-10"></a></span>
<span id="cb20-11"><a href="#cb20-11"></a><span class="at">go</span>()<span class="op">;</span></span></code></pre></div>
<p>But there’s still one thing missing. The above code will work so long as nothing goes wrong with either asynchronous operation. This is not a fair comparison to the final code using callbacks or promises unless we include error handling. With async/await, the way to handle errors is by using the <code>try...catch</code> statement. It works a lot like an <code>if...else</code> statement. The <code>try</code> block runs if there are no errors, otherwise the <code>catch</code> block runs and catches the error as well.</p>
<p>The final code is as follows.</p>
<div class="sourceCode" id="cb21" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb21-1"><a href="#cb21-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">'fs'</span>).<span class="at">promises</span><span class="op">;</span></span>
<span id="cb21-2"><a href="#cb21-2"></a></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="kw">const</span> go <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb21-4"><a href="#cb21-4"></a>  <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb21-5"><a href="#cb21-5"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Starting task...'</span>)<span class="op">;</span></span>
<span id="cb21-6"><a href="#cb21-6"></a>    <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="va">fs</span>.<span class="at">readFile</span>(<span class="st">'first.txt'</span><span class="op">,</span> <span class="st">'utf8'</span>)<span class="op">;</span></span>
<span id="cb21-7"><a href="#cb21-7"></a>    <span class="kw">const</span> parts <span class="op">=</span> <span class="va">data</span>.<span class="at">split</span>(<span class="st">'---'</span>)<span class="op">;</span></span>
<span id="cb21-8"><a href="#cb21-8"></a>    <span class="cf">await</span> <span class="va">fs</span>.<span class="at">writeFile</span>(<span class="st">'second.txt'</span><span class="op">,</span> parts[<span class="dv">0</span>]<span class="op">,</span> <span class="st">'utf8'</span>)<span class="op">;</span></span>
<span id="cb21-9"><a href="#cb21-9"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Successfully copied the contents!'</span>)<span class="op">;</span></span>
<span id="cb21-10"><a href="#cb21-10"></a>  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></span>
<span id="cb21-11"><a href="#cb21-11"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Something went wrong:'</span>)<span class="op">;</span></span>
<span id="cb21-12"><a href="#cb21-12"></a>    <span class="va">console</span>.<span class="at">log</span>(err)<span class="op">;</span></span>
<span id="cb21-13"><a href="#cb21-13"></a>  <span class="op">}</span></span>
<span id="cb21-14"><a href="#cb21-14"></a><span class="op">};</span></span>
<span id="cb21-15"><a href="#cb21-15"></a></span>
<span id="cb21-16"><a href="#cb21-16"></a><span class="at">go</span>()<span class="op">;</span></span></code></pre></div>
<h2 id="comparison">Comparison</h2>
<h3 id="task">Task</h3>
<p>We start with a file ‘notes.txt’ that has public and private text, separated by a line ‘<code>---</code>’. Copy the public notes into a file ‘public.txt’, then copy the private notes into a file ‘private.txt’. Finally, remove the original file ‘notes.txt’.</p>
<h3 id="with-callbacks">With callbacks</h3>
<div class="sourceCode" id="cb22" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb22-1"><a href="#cb22-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">'fs'</span>)<span class="op">;</span></span>
<span id="cb22-2"><a href="#cb22-2"></a></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="kw">const</span> afterCopy <span class="op">=</span> err <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb22-4"><a href="#cb22-4"></a>  <span class="cf">if</span> (err) <span class="op">{</span></span>
<span id="cb22-5"><a href="#cb22-5"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Something went wrong:'</span>)<span class="op">;</span></span>
<span id="cb22-6"><a href="#cb22-6"></a>    <span class="cf">throw</span> err<span class="op">;</span></span>
<span id="cb22-7"><a href="#cb22-7"></a>  <span class="op">}</span></span>
<span id="cb22-8"><a href="#cb22-8"></a></span>
<span id="cb22-9"><a href="#cb22-9"></a>  <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Removing original file...'</span>)<span class="op">;</span></span>
<span id="cb22-10"><a href="#cb22-10"></a>  <span class="va">fs</span>.<span class="at">unlink</span>(<span class="st">'notes.txt'</span><span class="op">,</span> err <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb22-11"><a href="#cb22-11"></a>    <span class="cf">if</span> (err) <span class="op">{</span></span>
<span id="cb22-12"><a href="#cb22-12"></a>      <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Something went wrong:'</span>)<span class="op">;</span></span>
<span id="cb22-13"><a href="#cb22-13"></a>      <span class="cf">throw</span> err<span class="op">;</span></span>
<span id="cb22-14"><a href="#cb22-14"></a>    <span class="op">}</span></span>
<span id="cb22-15"><a href="#cb22-15"></a></span>
<span id="cb22-16"><a href="#cb22-16"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Finished!'</span>)<span class="op">;</span></span>
<span id="cb22-17"><a href="#cb22-17"></a>  <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb22-18"><a href="#cb22-18"></a><span class="op">};</span></span>
<span id="cb22-19"><a href="#cb22-19"></a></span>
<span id="cb22-20"><a href="#cb22-20"></a><span class="kw">const</span> afterRead <span class="op">=</span> (err<span class="op">,</span> notes) <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb22-21"><a href="#cb22-21"></a>  <span class="cf">if</span> (err) <span class="op">{</span></span>
<span id="cb22-22"><a href="#cb22-22"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Something went wrong:'</span>)<span class="op">;</span></span>
<span id="cb22-23"><a href="#cb22-23"></a>    <span class="cf">throw</span> err<span class="op">;</span></span>
<span id="cb22-24"><a href="#cb22-24"></a>  <span class="op">}</span></span>
<span id="cb22-25"><a href="#cb22-25"></a></span>
<span id="cb22-26"><a href="#cb22-26"></a>  <span class="kw">const</span> [publicNotes<span class="op">,</span> privateNotes] <span class="op">=</span> <span class="va">notes</span>.<span class="at">split</span>(<span class="st">'---'</span>)<span class="op">;</span></span>
<span id="cb22-27"><a href="#cb22-27"></a></span>
<span id="cb22-28"><a href="#cb22-28"></a>  <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Copying public notes...'</span>)<span class="op">;</span></span>
<span id="cb22-29"><a href="#cb22-29"></a>  <span class="va">fs</span>.<span class="at">writeFile</span>(<span class="st">'public.txt'</span><span class="op">,</span> publicNotes<span class="op">,</span> <span class="st">'utf8'</span><span class="op">,</span> err <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb22-30"><a href="#cb22-30"></a>    <span class="cf">if</span> (err) <span class="op">{</span></span>
<span id="cb22-31"><a href="#cb22-31"></a>      <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Something went wrong:'</span>)<span class="op">;</span></span>
<span id="cb22-32"><a href="#cb22-32"></a>      <span class="cf">throw</span> err<span class="op">;</span></span>
<span id="cb22-33"><a href="#cb22-33"></a>    <span class="op">}</span></span>
<span id="cb22-34"><a href="#cb22-34"></a></span>
<span id="cb22-35"><a href="#cb22-35"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Copying private notes...'</span>)<span class="op">;</span></span>
<span id="cb22-36"><a href="#cb22-36"></a>    <span class="va">fs</span>.<span class="at">writeFile</span>(<span class="st">'private.txt'</span><span class="op">,</span> privateNotes<span class="op">,</span> <span class="st">'utf8'</span><span class="op">,</span> afterCopy)<span class="op">;</span></span>
<span id="cb22-37"><a href="#cb22-37"></a>  <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb22-38"><a href="#cb22-38"></a><span class="op">};</span></span>
<span id="cb22-39"><a href="#cb22-39"></a></span>
<span id="cb22-40"><a href="#cb22-40"></a><span class="va">fs</span>.<span class="at">readFile</span>(<span class="st">'notes.txt'</span><span class="op">,</span> <span class="st">'utf8'</span><span class="op">,</span> afterRead)<span class="op">;</span></span></code></pre></div>
<h3 id="with-promises">With promises</h3>
<div class="sourceCode" id="cb23" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb23-1"><a href="#cb23-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">'fs'</span>).<span class="at">promises</span><span class="op">;</span></span>
<span id="cb23-2"><a href="#cb23-2"></a></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="va">fs</span>.<span class="at">readFile</span>(<span class="st">'notes.txt'</span><span class="op">,</span> <span class="st">'utf8'</span>)</span>
<span id="cb23-4"><a href="#cb23-4"></a>  .<span class="at">then</span>(notes <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb23-5"><a href="#cb23-5"></a>    <span class="kw">const</span> [publicNotes<span class="op">,</span> privateNotes] <span class="op">=</span> <span class="va">notes</span>.<span class="at">split</span>(<span class="st">'---'</span>)<span class="op">;</span></span>
<span id="cb23-6"><a href="#cb23-6"></a></span>
<span id="cb23-7"><a href="#cb23-7"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Copying public notes...'</span>)<span class="op">;</span></span>
<span id="cb23-8"><a href="#cb23-8"></a>    <span class="cf">return</span> <span class="va">fs</span>.<span class="at">writeFile</span>(<span class="st">'public.txt'</span><span class="op">,</span> publicNotes<span class="op">,</span> <span class="st">'utf8'</span>)</span>
<span id="cb23-9"><a href="#cb23-9"></a>      .<span class="at">then</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb23-10"><a href="#cb23-10"></a>        <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Copying private notes...'</span>)<span class="op">;</span></span>
<span id="cb23-11"><a href="#cb23-11"></a>        <span class="cf">return</span> <span class="va">fs</span>.<span class="at">writeFile</span>(<span class="st">'private.txt'</span><span class="op">,</span> privateNotes<span class="op">,</span> <span class="st">'utf8'</span>)<span class="op">;</span></span>
<span id="cb23-12"><a href="#cb23-12"></a>      <span class="op">}</span>)</span>
<span id="cb23-13"><a href="#cb23-13"></a>  <span class="op">}</span>)</span>
<span id="cb23-14"><a href="#cb23-14"></a>  .<span class="at">then</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb23-15"><a href="#cb23-15"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Removing original file...'</span>)<span class="op">;</span></span>
<span id="cb23-16"><a href="#cb23-16"></a>    <span class="cf">return</span> <span class="va">fs</span>.<span class="at">unlink</span>(<span class="st">'notes.txt'</span>)<span class="op">;</span></span>
<span id="cb23-17"><a href="#cb23-17"></a>  <span class="op">}</span>)</span>
<span id="cb23-18"><a href="#cb23-18"></a>  .<span class="at">then</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb23-19"><a href="#cb23-19"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Finished!'</span>)<span class="op">;</span></span>
<span id="cb23-20"><a href="#cb23-20"></a>  <span class="op">}</span>)</span>
<span id="cb23-21"><a href="#cb23-21"></a>  .<span class="at">catch</span>(err <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb23-22"><a href="#cb23-22"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Something went wrong:'</span>)<span class="op">;</span></span>
<span id="cb23-23"><a href="#cb23-23"></a>    <span class="va">console</span>.<span class="at">log</span>(err)<span class="op">;</span></span>
<span id="cb23-24"><a href="#cb23-24"></a>  <span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
<h3 id="with-asyncawait">With async/await</h3>
<div class="sourceCode" id="cb24" data-org-language="js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb24-1"><a href="#cb24-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">'fs'</span>).<span class="at">promises</span><span class="op">;</span></span>
<span id="cb24-2"><a href="#cb24-2"></a></span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="kw">const</span> go <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb24-4"><a href="#cb24-4"></a>  <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb24-5"><a href="#cb24-5"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Gathering notes...'</span>)<span class="op">;</span></span>
<span id="cb24-6"><a href="#cb24-6"></a>    <span class="kw">const</span> notes <span class="op">=</span> <span class="cf">await</span> <span class="va">fs</span>.<span class="at">readFile</span>(<span class="st">'notes.txt'</span><span class="op">,</span> <span class="st">'utf8'</span>)<span class="op">;</span></span>
<span id="cb24-7"><a href="#cb24-7"></a>    <span class="kw">const</span> [publicNotes<span class="op">,</span> privateNotes] <span class="op">=</span> <span class="va">notes</span>.<span class="at">split</span>(<span class="st">'---'</span>)<span class="op">;</span></span>
<span id="cb24-8"><a href="#cb24-8"></a></span>
<span id="cb24-9"><a href="#cb24-9"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Copying public notes...'</span>)<span class="op">;</span></span>
<span id="cb24-10"><a href="#cb24-10"></a>    <span class="cf">await</span> <span class="va">fs</span>.<span class="at">writeFile</span>(<span class="st">'public.txt'</span><span class="op">,</span> publicNotes<span class="op">,</span> <span class="st">'utf8'</span>)<span class="op">;</span></span>
<span id="cb24-11"><a href="#cb24-11"></a></span>
<span id="cb24-12"><a href="#cb24-12"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Copying private notes...'</span>)<span class="op">;</span></span>
<span id="cb24-13"><a href="#cb24-13"></a>    <span class="cf">await</span> <span class="va">fs</span>.<span class="at">writeFile</span>(<span class="st">'private.txt'</span><span class="op">,</span> privateNotes<span class="op">,</span> <span class="st">'utf8'</span>)<span class="op">;</span></span>
<span id="cb24-14"><a href="#cb24-14"></a></span>
<span id="cb24-15"><a href="#cb24-15"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Removing original file...'</span>)<span class="op">;</span></span>
<span id="cb24-16"><a href="#cb24-16"></a>    <span class="cf">await</span> <span class="va">fs</span>.<span class="at">unlink</span>(<span class="st">'notes.txt'</span>)<span class="op">;</span></span>
<span id="cb24-17"><a href="#cb24-17"></a></span>
<span id="cb24-18"><a href="#cb24-18"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Finished!'</span>)<span class="op">;</span></span>
<span id="cb24-19"><a href="#cb24-19"></a>  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></span>
<span id="cb24-20"><a href="#cb24-20"></a>    <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Something went wrong:'</span>)<span class="op">;</span></span>
<span id="cb24-21"><a href="#cb24-21"></a>    <span class="va">console</span>.<span class="at">log</span>(err)<span class="op">;</span></span>
<span id="cb24-22"><a href="#cb24-22"></a>  <span class="op">}</span></span>
<span id="cb24-23"><a href="#cb24-23"></a><span class="op">};</span></span>
<span id="cb24-24"><a href="#cb24-24"></a></span>
<span id="cb24-25"><a href="#cb24-25"></a><span class="at">go</span>()<span class="op">;</span></span></code></pre></div>
	</section>
	
	<section id="prev-and-next-links">
		<a id="next-link" href="../lessons/12-batteries.html">
			<div>
				<p>Next lesson</p>
				<h2>Project - batteries.js</h2>
			</div>
			<i class="fas fa-arrow-right"></i>
		</a>
	</section>
	
</article>

		</main>

		<footer>
			<div>
				<h2><span id="created-by">Created by </span><a id="personal-link" href="https://timjohns.ca/">Tim Johns</a></h2>
				<div id="social-links">
					<a href="https://github.com/SlimTim10">
						<svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg>
					</a>
					<a href="https://www.linkedin.com/in/tim-johns/">
						<svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path></svg>
					</a>
				</div>
			</div>
			<div>
				<p>© 2021 Tim Johns</p>
				<p>Site proudly generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a> | <a href="https://github.com/SlimTim10/Intuitive-JavaScript"> View source</a></p>
			</div>
		</footer>
	</body>
</html>
